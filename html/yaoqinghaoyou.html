<!doctype html>
<html class="no-js">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="">
    <meta name="keywords" content="">
    <meta name="viewport"content="width=device-width, initial-scale=1">
    <meta name="renderer" content="webkit">
    <meta http-equiv="Cache-Control" content="no-siteapp"/>
    <!-- common -->
    <link rel="stylesheet" href="../css/amazeui.min.css">
    <link rel="stylesheet" href="../css/app.css">
    <link rel="stylesheet" href="../css/common.css">
    <script src="../js/jquery.min.js"></script>
    <script src="../js/amazeui.min.js"></script>
    <script src="../plugin/layer/layer.js"></script>
    <script src="../js/common.js"></script>

    <!--分享到微信-->
    <script type="text/javascript" src="https://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
    <script src="../js/checkLogin.js"></script>

    <!-- page -->
    <link rel="stylesheet" href="../css/index.css">

    <title>太和·投融宝</title>
</head>
<body>
    <div class="imgBox" style="width:100%;">
        <img src="../images/fenxiang.png" alt="" style="width:100%;">
    </div>
<div style="margin:20px 0px;text-align: center;" id="fenxiang">
    <button type="button" class="am-btn am-btn-danger" style="width:90%;" onclick="fenxiang();">分享给好友</button>
</div>

    <p style="font-size: 14px;text-align: center;" id="mx">
        <a href="./shouzhimingxi.html" style="color:#333;text-decoration:underline;">
            查看邀请好友及奖励明细
        </a>
    </p>

    <div style="margin:20px 0px;text-align: center;" id="zhuce">
        <button type="button" class="am-btn am-btn-danger" style="width:95%;" onclick="zhuce();">立即注册</button>
    </div>

</body>
<script type="text/javascript">

    var user = localStorage.getItem('TRQuserid');
    /* 判断是否登录 */
    if (user == null ){
        $('#fenxiang').css({display:'none'})
        $('#mx').css({display:'none'})
    }else{
        $('#zhuce').css({display:'none'})
    }


    function getUrlPar(name){
        var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
        var r = window.location.search.substr(1).match(reg);
        if(r!=null)return  unescape(r[2]); return null;
    };

    function fenxiang() {
        layer.msg('已生成您的唯一专属ID链接，请点击右上角  [···]  功能菜单按钮，分享并邀请金融圈好友注册，被邀请人注册成为平台会员，将奖励邀请人200元/人，奖励金额无上限。',
            {
            time:7500,
        })
    }
    
    function zhuce() {
        var userId = getUrlPar('userId');
        window.location.href = './registered.html?userId='+userId;
    }

    $(function(){
        var url = location.href.split('#').toString();//url不能写死
        console.log('url',url);
        $.ajax({
            type : "POST",
            url: WWW_URL + '/share/wx',
            dataType : "json",
            async : false,
            headers: HEADER,
            data:{url:url},
            success : function(data) {
                if(data.msg==='Success'){
                    wx.config({
                        debug: true,////生产环境需要关闭debug模式
                        appId: data.data.appId,//appId通过微信服务号后台查看
                        timestamp: data.data.timestamp,//生成签名的时间戳
                        nonceStr: data.data.nonceStr,//生成签名的随机字符串
                        signature: data.data.signature,//签名
                        jsApiList: [//需要调用的JS接口列表
                            'w',//判断当前客户端版本是否支持指定JS接口
                            'onMenuShareTimeline',//分享给好友
                            'onMenuShareAppMessage'//分享到朋友圈
                        ]
                    });
                    wx.ready(function () {
                        var link = window.location.href;
                        var protocol = window.location.protocol;
                        var host = window.location.host;
                        //分享朋友圈
                        wx.onMenuShareTimeline({
                            title: '这是一个自定义的标题！',
                            link: link,
                            imgUrl: protocol+'//'+host+'/www/images/fenxiang.png',// 自定义图标
                            trigger: function (res) {
                                // 不要尝试在trigger中使用ajax异步请求修改本次分享的内容，因为客户端分享操作是一个同步操作，这时候使用ajax的回包会还没有返回.
                                //alert('click shared');
                            },
                            success: function (res) {
                                //alert('shared success');
                                //some thing you should do
                            },
                            cancel: function (res) {
                                //alert('shared cancle');
                            },
                            fail: function (res) {
                                //alert(JSON.stringify(res));
                            }
                        });
                        //分享给好友
                        wx.onMenuShareAppMessage({
                            title: '这是一个自定义的标题！', // 分享标题
                            desc: '这是一个自定义的描述！', // 分享描述
                            link: link, // 分享链接，该链接域名或路径必须与当前页面对应的公众号JS安全域名一致
                            imgUrl: protocol+'//'+host+'/www/images/fenxiang.png', // 自定义图标
                            type: 'link', // 分享类型,music、video或link，不填默认为link
                            dataUrl: '', // 如果type是music或video，则要提供数据链接，默认为空
                            success: function () {
                                // 用户确认分享后执行的回调函数
                            },
                            cancel: function () {
                                // 用户取消分享后执行的回调函数
                            }
                        });
                        wx.error(function (res) {
                            alert(res.errMsg);
                        });
                    });
                }

            },
            error: function(xhr, status, error) {
                //alert(status);
                //alert(xhr.responseText);
            }
        })
    });

</script>
</html>
